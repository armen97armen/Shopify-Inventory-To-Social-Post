<?php

error_reporting(E_ALL);
ini_set('display_errors', 1);

// Replicate API Token
// Get your token from: https://replicate.com/account/api-tokens
define('REPLICATE_TOKEN', 'YOUR_REPLICATE_TOKEN_HERE');

header('Content-Type: application/json');

try {
    // Get input
    $shopifyUrl = $_POST['shopify_url'] ?? '';
    $xProfileLink = $_POST['x_profile_link'] ?? 'https://x.com/dope_as_yola';
    
    if (empty($shopifyUrl)) {
        throw new Exception('Missing required parameters');
    }
    
    // Step 1: Scrape Shopify page to get product image
    $productData = scrapeShopify($shopifyUrl);
    
    // Step 2: Generate tweet with comprehensive prompt
    $tweetPrompt = trim(file_get_contents('prompt_template.txt'));
    
    // Replace the X profile link variable in the prompt template with the user's setting
    $tweetPrompt = str_replace('{X_PROFILE_LINK}', $xProfileLink, $tweetPrompt);
    
    $rawAIOutput = callReplicateAPI($tweetPrompt, $productData['image']);
    
    // Clean up the tweet - extract only the tweet text
    $generatedTweet = trim($rawAIOutput);
    
    // Clean up spacing - remove ALL extra whitespace including newlines
    $generatedTweet = preg_replace('/\s+/u', ' ', $generatedTweet);
    $generatedTweet = trim($generatedTweet);
    
    // Ensure under 280 chars
    $generatedTweet = substr($generatedTweet, 0, 280);
    
    // Return JSON response
    echo json_encode([
        'tweet' => $generatedTweet,
        'image_url' => $productData['image']
    ]);
    
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(['error' => $e->getMessage()]);
}

function callReplicateAPI($prompt, $imageUrl = null) {
    $input = [
        'prompt' => $prompt,
        'messages' => [],
        'verbosity' => 'medium',
        'image_input' => [],
        'reasoning_effort' => 'minimal'
    ];
    
    // Add image if provided
    if ($imageUrl) {
        $input['image_input'] = [$imageUrl];
    }
    
    $postData = json_encode(['input' => $input]);
    
    $ch = curl_init('https://api.replicate.com/v1/models/openai/gpt-5-nano/predictions');
    
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $postData,
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . REPLICATE_TOKEN,
            'Content-Type: application/json',
            'Prefer: wait'
        ]
    ]);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode !== 200 && $httpCode !== 201) {
        throw new Exception('Replicate API Error: HTTP ' . $httpCode . ' - ' . $response);
    }
    
    $data = json_decode($response, true);
    
    if (!isset($data['output'])) {
        // Try different output formats
        if (isset($data['text'])) {
            return $data['text'];
        }
        if (isset($data['result'])) {
            return $data['result'];
        }
        throw new Exception('Invalid response from Replicate API: ' . $response);
    }
    
    // Handle output if it's an array (multiple outputs)
    if (is_array($data['output'])) {
        return implode('', $data['output']);  // Try no delimiter first
    }
    
    return $data['output'];
}

function scrapeShopify($url) {
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    ]);
    
    $html = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    
    if ($httpCode !== 200) {
        throw new Exception('Failed to fetch Shopify page');
    }
    
    libxml_use_internal_errors(true);
    $dom = new DOMDocument();
    $dom->loadHTML($html);
    libxml_clear_errors();
    
    $xpath = new DOMXPath($dom);
    
    // Extract product image
    $image = '';
    $imageNodes = $xpath->query('//meta[@property="og:image"]');
    if ($imageNodes->length > 0) {
        $image = $imageNodes->item(0)->getAttribute('content');
    } else {
        // Try other image selectors
        $imageNodes = $xpath->query('//img[@class="product-image"] | //img[@id="product-image"] | //img[contains(@class, "product")]');
        if ($imageNodes->length > 0) {
            $image = $imageNodes->item(0)->getAttribute('src');
        }
    }
    
    // Fallback if nothing found
    if (empty($image)) {
        $image = 'https://via.placeholder.com/800x600?text=Product';
    }
    
    return ['image' => $image];
}

