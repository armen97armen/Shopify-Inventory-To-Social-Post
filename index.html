<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tweet Generator - Powered by AI</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css">
    <link id="theme-stylesheet" rel="stylesheet" href="themes/dark.css">
    <style>
        @keyframes orbit-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes star-pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }
        @keyframes fade-in-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .orbit-spin { animation: orbit-spin 20s linear infinite; }
        .star-pulse { animation: star-pulse 3s ease-in-out infinite; }
        .fade-in-up { animation: fade-in-up 0.5s ease-out; }
        .float { animation: float 3s ease-in-out infinite; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'black-void': '#000000',
                        'dark-carbon': '#0a0a0a',
                        'glass-dark': '#1a1a1a',
                        'chrome-accent': '#2a2a2a',
                        'neon-blue': '#0080ff',
                        'neon-pink': '#ff0080',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-black-void font-sans">
    <!-- Subtle gradient overlay -->
    <div class="fixed inset-0 bg-gradient-to-b from-black-void via-dark-carbon to-black-void pointer-events-none"></div>
    
    <!-- Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 backdrop-blur-lg bg-glass-dark/40 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-end items-center gap-3">
            <!-- Theme Toggle Button -->
            <button 
                id="themeToggleBtn"
                class="p-3 bg-glass-dark/60 backdrop-blur-md border border-white/20 rounded-xl text-white/90 hover:text-white hover:border-white/40 transition-all hover:scale-[1.02]"
                title="Toggle theme"
            >
                <!-- Sun Icon (visible in dark mode) -->
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon (visible in light mode) -->
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
            
            <!-- Settings Button -->
            <button 
                id="settingsBtn"
                class="p-3 bg-glass-dark/60 backdrop-blur-md border border-white/20 rounded-xl text-white/90 hover:text-white hover:border-white/40 transition-all hover:scale-[1.02]"
                title="Settings"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-6 py-16 mt-20 relative z-10">
        <!-- Title -->
        <div class="flex items-center justify-center mb-12">
            <h1 class="text-5xl md:text-7xl font-bold text-center bg-clip-text text-transparent bg-gradient-to-r from-neon-blue to-neon-pink floating">
                Tweet Generator
                <span class="block text-2xl md:text-3xl font-normal mt-4 text-white/40 tracking-tight">
                    Powered by AI
                </span>
            </h1>
        </div>
        
        <!-- Settings Panel -->
        <div id="settingsPanel" class="hidden mb-8 backdrop-blur-lg bg-glass-dark/30 border border-white/10 rounded-2xl p-8 shadow-2xl fade-in-up z-20 relative font-sans">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-white mb-3 tracking-tight">Settings & API Credentials</h2>
                <p class="text-white/80 text-sm leading-relaxed">Configure your API tokens and preferences for tweet generation and posting.</p>
            </div>

            <!-- Content Generation Settings Section -->
            <div class="mb-8 pb-8 border-b border-white/20">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-11 h-11 rounded-xl bg-neon-blue/20 border border-neon-blue/30 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-neon-blue" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Content Generation</h3>
                        <p class="text-white/70 text-xs mt-0.5">Settings for AI-powered tweet creation</p>
                    </div>
                </div>

                <!-- X Profile Link -->
                <div class="mb-6 ml-14">
                    <label for="xProfileLink" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                        X (Twitter) Profile Link
                    </label>
                    <input 
                        type="url" 
                        id="xProfileLink" 
                        placeholder="https://x.com/username" 
                        class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-neon-blue/60 focus:border-neon-blue/50 transition-all backdrop-blur-sm font-sans"
                    >
                    <div class="mt-3 p-4 bg-chrome-accent/60 rounded-xl border border-white/20 min-h-fit">
                        <p class="text-white/85 text-sm leading-relaxed mb-3">
                            <strong class="text-white font-semibold">Purpose:</strong> The AI will analyze the writing style from this X profile to generate tweets that match the tone, voice, and style of the selected profile. This profile's tweets serve as a reference for creating authentic-sounding content.
                        </p>
                        <p class="text-white/70 text-sm">
                            <strong class="text-white/90">Example:</strong> <span class="text-white/80 font-mono text-xs">https://x.com/dope_as_yola</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Replicate API Section -->
            <div class="mb-8 pb-8 border-b border-white/20">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-11 h-11 rounded-xl bg-neon-pink/20 border border-neon-pink/30 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-neon-pink" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Replicate API</h3>
                        <p class="text-white/70 text-xs mt-0.5">AI model access for style analysis and tweet generation</p>
                    </div>
                </div>

                <div class="ml-14">
                    <label for="replicateToken" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                        API Token
                    </label>
                    <input 
                        type="text" 
                        id="replicateToken" 
                        placeholder="r8_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
                        class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-neon-pink/60 focus:border-neon-pink/50 transition-all backdrop-blur-sm font-mono"
                    >
                    <div class="mt-3 p-4 bg-chrome-accent/60 rounded-xl border border-white/20 min-h-fit">
                        <p class="text-white/85 text-sm leading-relaxed mb-3">
                            <strong class="text-white font-semibold">Purpose:</strong> This token authenticates your access to Replicate's AI models (Grok-4 for style analysis and GPT-5-Nano for tweet generation). Required for all AI-powered features.
                        </p>
                        <p class="text-white/75 text-sm mb-3">
                            <strong class="text-white/90">Services Used:</strong> Grok-4 (style analysis) • GPT-5-Nano (tweet generation, capitalization)
                        </p>
                        <p class="text-white/75 text-sm">
                            <strong class="text-white/90">Get your token:</strong> <a href="https://replicate.com/account/api-tokens" target="_blank" class="text-neon-pink hover:text-neon-pink/90 underline font-medium">replicate.com/account/api-tokens</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Twitter/X API Section -->
            <div class="mb-8">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-11 h-11 rounded-xl bg-neon-blue/20 border border-neon-blue/30 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-neon-blue" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">Twitter / X API</h3>
                        <p class="text-white/70 text-xs mt-0.5">Authentication for posting tweets to X</p>
                    </div>
                </div>

                <div class="ml-14 space-y-5">
                    <!-- API Key -->
                    <div>
                        <label for="twitterApiKey" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            API Key <span class="text-white/70 font-normal text-xs">(Consumer Key)</span>
                        </label>
                        <input 
                            type="text" 
                            id="twitterApiKey" 
                            placeholder="Your Twitter API Key" 
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-neon-blue/60 focus:border-neon-blue/50 transition-all backdrop-blur-sm font-mono"
                        >
                        <p class="mt-2.5 text-white/75 text-sm leading-relaxed">Your Twitter app's API Key (Consumer Key). Identifies your application.</p>
                    </div>

                    <!-- API Secret -->
                    <div>
                        <label for="twitterApiSecret" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            API Secret <span class="text-white/70 font-normal text-xs">(Consumer Secret)</span>
                        </label>
                        <input 
                            type="text" 
                            id="twitterApiSecret" 
                            placeholder="Your Twitter API Secret" 
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-neon-blue/60 focus:border-neon-blue/50 transition-all backdrop-blur-sm font-mono"
                        >
                        <p class="mt-2.5 text-white/75 text-xs leading-relaxed">Your Twitter app's API Secret (Consumer Secret). Keep this confidential.</p>
                    </div>

                    <!-- Access Token -->
                    <div>
                        <label for="twitterAccessToken" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            Access Token
                        </label>
                        <input 
                            type="text" 
                            id="twitterAccessToken" 
                            placeholder="Your Twitter Access Token" 
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-neon-blue/60 focus:border-neon-blue/50 transition-all backdrop-blur-sm font-mono"
                        >
                        <p class="mt-2.5 text-white/75 text-xs leading-relaxed">OAuth access token that authorizes your app to post tweets on your behalf.</p>
                    </div>

                    <!-- Access Secret -->
                    <div>
                        <label for="twitterAccessSecret" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            Access Secret
                        </label>
                        <input 
                            type="text" 
                            id="twitterAccessSecret" 
                            placeholder="Your Twitter Access Secret" 
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-neon-blue/60 focus:border-neon-blue/50 transition-all backdrop-blur-sm font-mono"
                        >
                        <p class="mt-2.5 text-white/75 text-xs leading-relaxed">OAuth access token secret. Paired with your Access Token for authentication.</p>
                    </div>

                    <!-- Documentation Box -->
                    <div class="mt-4 p-4 bg-chrome-accent/60 rounded-xl border border-white/20 min-h-fit">
                        <p class="text-white/85 text-sm leading-relaxed mb-3">
                            <strong class="text-white font-semibold">Purpose:</strong> These credentials authenticate your application with Twitter's API to post generated tweets directly to X. All four credentials are required for posting functionality.
                        </p>
                        <p class="text-white/75 text-sm mb-3">
                            <strong class="text-white/90">How to get these:</strong> Create a Twitter Developer account and app at <a href="https://developer.twitter.com" target="_blank" class="text-neon-blue hover:text-neon-blue/90 underline font-medium">developer.twitter.com</a>
                        </p>
                        <p class="text-white/75 text-sm">
                            <strong class="text-white/90">Note:</strong> These credentials are stored locally in your browser and sent only when posting tweets. They are never shared with third parties.
                        </p>
                    </div>
                </div>
            </div>

            <!-- AI Prompts Section -->
            <div class="mb-8 pb-8 border-b border-white/20">
                <div class="flex items-center gap-3 mb-5">
                    <div class="w-11 h-11 rounded-xl bg-purple-500/20 border border-purple-500/30 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white tracking-tight">AI Prompts</h3>
                        <p class="text-white/70 text-xs mt-0.5">Customize AI behavior by editing prompt templates</p>
                    </div>
                </div>

                <div class="ml-14 space-y-5">
                    <!-- GPT Generation Prompt -->
                    <div>
                        <label for="gptGenerationPrompt" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            Tweet Generation Prompt
                        </label>
                        <textarea 
                            id="gptGenerationPrompt"
                            rows="12"
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:border-purple-500/50 transition-all backdrop-blur-sm font-mono text-xs"
                            style="font-family: 'Courier New', monospace; resize: vertical;"
                        ></textarea>
                        <p class="mt-2.5 text-white/75 text-xs leading-relaxed">Prompt used by GPT-5-Nano to generate tweets. Variables: {X_PROFILE_LINK}, {EXTRACTED_TWEETS}, {MAX_TWEET_LENGTH}</p>
                    </div>

                    <!-- Capitalization Prompt -->
                    <div>
                        <label for="capitalizationPrompt" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            Capitalization Prompt
                        </label>
                        <textarea 
                            id="capitalizationPrompt"
                            rows="12"
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:border-purple-500/50 transition-all backdrop-blur-sm font-mono text-xs"
                            style="font-family: 'Courier New', monospace; resize: vertical;"
                        ></textarea>
                        <p class="mt-2.5 text-white/75 text-xs leading-relaxed">Prompt used by GPT-5-Nano to fix capitalization. Variable: {TWEET_TEXT}</p>
                    </div>

                    <!-- Style Analysis Prompt -->
                    <div>
                        <label for="styleAnalysisPrompt" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                            Style Analysis Prompt
                        </label>
                        <textarea 
                            id="styleAnalysisPrompt"
                            rows="12"
                            class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:border-purple-500/50 transition-all backdrop-blur-sm font-mono text-xs"
                            style="font-family: 'Courier New', monospace; resize: vertical;"
                        ></textarea>
                        <p class="mt-2.5 text-white/75 text-xs leading-relaxed">Prompt used by Grok-4 to analyze writing style from X profile. Variable: {X_PROFILE_LINK}</p>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-4 pt-6 border-t border-white/20">
                <button 
                    id="saveSettingsBtn"
                    class="flex-1 px-6 py-3.5 bg-neon-blue hover:bg-neon-blue/90 text-white font-semibold rounded-xl transition-all hover:scale-[1.005] shadow-lg shadow-neon-blue/30 tracking-tight"
                >
                    Save Settings
                </button>
                <button 
                    id="cancelSettingsBtn"
                    class="px-6 py-3.5 bg-chrome-accent/80 hover:bg-chrome-accent border border-white/20 text-white/90 hover:text-white font-semibold rounded-xl transition-all hover:scale-[1.005] tracking-tight"
                >
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Form Card -->
        <div class="backdrop-blur-lg bg-glass-dark/30 border border-white/5 rounded-2xl p-8 shadow-2xl fade-in-up">
            <form id="generateForm" aria-label="Generate tweet form">
                <div class="mb-6">
                    <label for="shopifyUrl" class="block mb-3 text-white/90 font-semibold text-lg">
                        Shopify Product URL
                    </label>
                    <input 
                        type="url" 
                        id="shopifyUrl" 
                        placeholder="https://example.com/products/item" 
                        required
                        class="w-full px-4 py-3 bg-chrome-accent/80 border border-white/20 rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-neon-blue/50 focus:border-white/30 transition-all backdrop-blur-sm"
                    >
                </div>
                
                <button 
                    type="submit" 
                    id="generateBtn"
                    class="generate-btn w-full py-4 px-6 bg-glass-dark/60 backdrop-blur-md text-white font-bold text-lg rounded-xl transition-all duration-300 transform hover:scale-[1.005] shadow-lg disabled:opacity-30 disabled:cursor-not-allowed disabled:transform-none relative overflow-hidden group"
                    title="Engage warp drive..."
                >
                    <span class="relative z-10">Generate Tweet</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-neon-blue/0 via-white/5 to-neon-pink/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-xl"></div>
                </button>
            </form>
        </div>
        
        <!-- Loading Steps -->
        <div id="loading" class="hidden mt-8">
            <!-- Orbital Ring Animation -->
            <div class="flex justify-center mb-6">
                <div class="relative w-32 h-32">
                    <div class="absolute inset-0 border-2 border-white/10 rounded-full"></div>
                    <div class="absolute inset-0 border-2 border-transparent border-t-neon-blue rounded-full orbit-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-3 h-3 bg-neon-blue rounded-full animate-pulse shadow-lg shadow-neon-blue/50"></div>
                    </div>
                </div>
            </div>
            
            <!-- Step Messages -->
            <div class="space-y-4">
                <div id="step1" class="loading-step bg-chrome-accent/60 backdrop-blur-sm border-l-2 border-neon-blue/50 p-4 rounded-lg hidden fade-in-up">
                    <span class="text-neon-blue font-semibold">•</span>
                    <span class="text-white/90 ml-3">Analyzing writing style from X profile...</span>
                </div>
                <div id="step2" class="loading-step bg-chrome-accent/60 backdrop-blur-sm border-l-2 border-neon-blue/50 p-4 rounded-lg hidden fade-in-up">
                    <span class="text-neon-blue font-semibold">•</span>
                    <span class="text-white/90 ml-3">Scraping Shopify product page...</span>
                </div>
                <div id="step3" class="loading-step bg-chrome-accent/60 backdrop-blur-sm border-l-2 border-neon-blue/50 p-4 rounded-lg hidden fade-in-up">
                    <span class="text-neon-blue font-semibold">•</span>
                    <span class="text-white/90 ml-3">Asking AI to write fire tweets...</span>
                </div>
                <div id="step4" class="loading-step bg-chrome-accent/60 backdrop-blur-sm border-l-2 border-neon-blue/50 p-4 rounded-lg hidden fade-in-up">
                    <span class="text-neon-blue font-semibold">•</span>
                    <span class="text-white/90 ml-3">Fixing capitalization naturally...</span>
                </div>
            </div>
        </div>
        
        <!-- Error Message -->
        <div id="error" class="hidden mt-8 bg-neon-pink/20 backdrop-blur-sm border border-neon-pink/50 text-neon-pink p-4 rounded-xl fade-in-up">
            <p class="font-semibold">Houston, we have a problem. Try again?</p>
            <p class="text-sm mt-2 text-white/80"></p>
        </div>
        
        <!-- Extracted Tweets Card -->
        <div id="extractedTweets" class="hidden mt-8 backdrop-blur-lg bg-glass-dark/40 border border-white/20 rounded-2xl p-8 shadow-2xl fade-in-up">
            <h2 class="text-2xl font-bold text-white mb-4">Writing Style Analysis from X Profile</h2>
            <p class="text-white/60 text-sm mb-4">This writing style analysis was used to generate your tweet:</p>
            <div class="bg-chrome-accent/60 backdrop-blur-sm p-6 rounded-xl border border-white/20 max-h-96 overflow-y-auto">
                <div id="extractedTweetsList" class="space-y-3 text-white/90 whitespace-pre-wrap text-sm leading-relaxed"></div>
            </div>
        </div>
        
        <!-- Preview Card -->
        <div id="preview" class="hidden mt-8 backdrop-blur-lg bg-glass-dark/40 border border-white/20 rounded-2xl p-8 shadow-2xl fade-in-up hover:border-white/30 transition-all">
            <h2 class="text-2xl font-bold text-white mb-6">Tweet Preview</h2>
            
            <div class="mb-6">
                <img id="previewImg" alt="Product Image" class="w-full rounded-xl border border-white/20">
            </div>
            
            <div class="bg-chrome-accent/60 backdrop-blur-sm p-6 rounded-xl border border-white/20 mb-6">
                <p id="previewTweet" class="text-white leading-relaxed whitespace-pre-wrap"></p>
            </div>
            
            <div class="flex gap-4">
                <button 
                    id="postBtn" 
                    class="post-btn flex-1 py-4 px-6 bg-glass-dark/60 backdrop-blur-md text-white font-bold text-lg rounded-xl transition-all duration-300 transform hover:scale-[1.005] disabled:opacity-30 disabled:cursor-not-allowed disabled:transform-none relative overflow-hidden group"
                >
                    <span class="relative z-10">POST IT</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-neon-blue/0 via-white/5 to-neon-pink/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-xl"></div>
                </button>
                <button 
                    id="scheduleBtn" 
                    class="post-btn flex-1 py-4 px-6 bg-glass-dark/60 backdrop-blur-md text-white font-bold text-lg rounded-xl transition-all duration-300 transform hover:scale-[1.005] disabled:opacity-30 disabled:cursor-not-allowed disabled:transform-none relative overflow-hidden group"
                >
                    <span class="relative z-10">SCHEDULE</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-neon-blue/0 via-white/5 to-neon-pink/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-xl"></div>
                </button>
            </div>
        </div>
        
        <!-- Scheduling Modal -->
        <div id="scheduleModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
            <div class="backdrop-blur-lg bg-glass-dark/40 border border-white/20 rounded-2xl p-8 shadow-2xl fade-in-up max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-white mb-6">Schedule Tweet</h2>
                
                <div class="mb-6">
                    <label for="scheduleDateTime" class="block mb-2.5 text-white font-semibold text-sm tracking-tight">
                        Date & Time
                    </label>
                    <input 
                        type="datetime-local" 
                        id="scheduleDateTime" 
                        class="w-full px-4 py-3.5 bg-chrome-accent border border-white/30 rounded-xl text-white text-sm focus:outline-none focus:ring-2 focus:ring-neon-blue/60 focus:border-neon-blue/50 transition-all backdrop-blur-sm font-sans"
                        required
                    >
                    <p class="mt-2.5 text-white/75 text-xs leading-relaxed">Select when you want this tweet to be posted.</p>
                </div>
                
                <div class="flex gap-4">
                    <button 
                        id="confirmScheduleBtn"
                        class="flex-1 px-6 py-3.5 bg-neon-blue hover:bg-neon-blue/90 text-white font-semibold rounded-xl transition-all hover:scale-[1.005] shadow-lg shadow-neon-blue/30 tracking-tight"
                    >
                        Schedule
                    </button>
                    <button 
                        id="cancelScheduleBtn"
                        class="px-6 py-3.5 bg-chrome-accent/80 hover:bg-chrome-accent border border-white/20 text-white/90 hover:text-white font-semibold rounded-xl transition-all hover:scale-[1.005] tracking-tight"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Scheduled Tweets Section -->
        <div id="scheduledTweets" class="mt-8 backdrop-blur-lg bg-glass-dark/40 border border-white/20 rounded-2xl p-8 shadow-2xl fade-in-up">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Scheduled Tweets</h2>
                <button 
                    id="refreshScheduledBtn"
                    class="p-2 bg-chrome-accent/60 hover:bg-chrome-accent border border-white/20 rounded-xl text-white/90 hover:text-white transition-all hover:scale-[1.02]"
                    title="Refresh"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
            
            <div id="scheduledTweetsList" class="space-y-4">
                <!-- Scheduled tweets will be loaded here -->
            </div>
            
            <div id="scheduledTweetsEmpty" class="text-center py-8 text-white/60">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-white/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-white/60">No scheduled tweets yet.</p>
                <p class="text-white/40 text-sm mt-2">Generate and schedule a tweet to see it here.</p>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let generatedData = null;

            // Theme Management
            let currentTheme = localStorage.getItem('theme') || 'dark';
            const themeStylesheet = $('#theme-stylesheet');
            
            function setTheme(theme) {
                currentTheme = theme;
                localStorage.setItem('theme', theme);
                themeStylesheet.attr('href', `themes/${theme}.css`);
                
                if (theme === 'dark') {
                    $('#sunIcon').removeClass('hidden');
                    $('#moonIcon').addClass('hidden');
                } else {
                    $('#sunIcon').addClass('hidden');
                    $('#moonIcon').removeClass('hidden');
                }
                
                // Add transition class to body for smooth color changes
                $('body').addClass('theme-transitioning');
                setTimeout(() => {
                    $('body').removeClass('theme-transitioning');
                }, 300);
            }
            
            // Initialize theme
            setTheme(currentTheme);
            
            // Theme toggle handler - smooth transition without reload
            $('#themeToggleBtn').on('click', function() {
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
            });

            // Load default settings from JSON file
            let defaultSettings = {
                xProfileLink: 'https://x.com/dope_as_yola',
                replicateToken: 'YOUR_REPLICATE_API_TOKEN_HERE',
                twitterApiKey: 'YOUR_TWITTER_API_KEY_HERE',
                twitterApiSecret: 'YOUR_TWITTER_API_SECRET_HERE',
                twitterAccessToken: 'YOUR_TWITTER_ACCESS_TOKEN_HERE',
                twitterAccessSecret: 'YOUR_TWITTER_ACCESS_SECRET_HERE'
            };

            // Fetch settings from JSON (async, but will update if available)
            fetch('config/settings.default.json')
                .then(response => response.json())
                .then(data => {
                    defaultSettings = {
                        xProfileLink: data.contentGeneration?.xProfileLink || defaultSettings.xProfileLink,
                        replicateToken: data.replicate?.apiToken || defaultSettings.replicateToken,
                        twitterApiKey: data.twitter?.apiKey || defaultSettings.twitterApiKey,
                        twitterApiSecret: data.twitter?.apiSecret || defaultSettings.twitterApiSecret,
                        twitterAccessToken: data.twitter?.accessToken || defaultSettings.twitterAccessToken,
                        twitterAccessSecret: data.twitter?.accessSecret || defaultSettings.twitterAccessSecret
                    };
                    // Update input fields if settings panel is already open
                    if (!$('#settingsPanel').hasClass('hidden')) {
                        initializeSettingsFields();
                    }
                })
                .catch(error => console.warn('Could not load settings.default.json, using fallback defaults:', error));

            // Initialize settings fields with values
            function initializeSettingsFields() {
                let xProfileLink = localStorage.getItem('xProfileLink') || defaultSettings.xProfileLink;
                let replicateToken = localStorage.getItem('replicateToken') || defaultSettings.replicateToken;
                let twitterApiKey = localStorage.getItem('twitterApiKey') || defaultSettings.twitterApiKey;
                let twitterApiSecret = localStorage.getItem('twitterApiSecret') || defaultSettings.twitterApiSecret;
                let twitterAccessToken = localStorage.getItem('twitterAccessToken') || defaultSettings.twitterAccessToken;
                let twitterAccessSecret = localStorage.getItem('twitterAccessSecret') || defaultSettings.twitterAccessSecret;

                $('#xProfileLink').val(xProfileLink);
                $('#replicateToken').val(replicateToken);
                $('#twitterApiKey').val(twitterApiKey);
                $('#twitterApiSecret').val(twitterApiSecret);
                $('#twitterAccessToken').val(twitterAccessToken);
                $('#twitterAccessSecret').val(twitterAccessSecret);
            }

            // Load saved values from localStorage, fallback to defaults
            let xProfileLink = localStorage.getItem('xProfileLink') || defaultSettings.xProfileLink;
            let replicateToken = localStorage.getItem('replicateToken') || defaultSettings.replicateToken;
            let twitterApiKey = localStorage.getItem('twitterApiKey') || defaultSettings.twitterApiKey;
            let twitterApiSecret = localStorage.getItem('twitterApiSecret') || defaultSettings.twitterApiSecret;
            let twitterAccessToken = localStorage.getItem('twitterAccessToken') || defaultSettings.twitterAccessToken;
            let twitterAccessSecret = localStorage.getItem('twitterAccessSecret') || defaultSettings.twitterAccessSecret;

            // Pre-fill input fields
            initializeSettingsFields();

            // Load prompts from server
            function loadPrompts() {
                fetch('prompts_handler.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.prompts) {
                            $('#gptGenerationPrompt').val(data.prompts.gptGeneration || '');
                            $('#capitalizationPrompt').val(data.prompts.capitalization || '');
                            $('#styleAnalysisPrompt').val(data.prompts.styleAnalysis || '');
                        }
                    })
                    .catch(error => console.warn('Could not load prompts:', error));
            }

            // Settings panel toggle
            $('#settingsBtn').on('click', function() {
                $('#settingsPanel').toggleClass('hidden');
                if (!$('#settingsPanel').hasClass('hidden')) {
                    // Refresh values when opening panel
                    initializeSettingsFields();
                    loadPrompts();
                }
            });

            // Save settings
            $('#saveSettingsBtn').on('click', function() {
                const newLink = $('#xProfileLink').val().trim();
                if (newLink && isValidUrl(newLink)) {
                    xProfileLink = newLink;
                    replicateToken = $('#replicateToken').val().trim() || defaultSettings.replicateToken;
                    twitterApiKey = $('#twitterApiKey').val().trim() || defaultSettings.twitterApiKey;
                    twitterApiSecret = $('#twitterApiSecret').val().trim() || defaultSettings.twitterApiSecret;
                    twitterAccessToken = $('#twitterAccessToken').val().trim() || defaultSettings.twitterAccessToken;
                    twitterAccessSecret = $('#twitterAccessSecret').val().trim() || defaultSettings.twitterAccessSecret;

                    // Save to localStorage
                    localStorage.setItem('xProfileLink', xProfileLink);
                    localStorage.setItem('replicateToken', replicateToken);
                    localStorage.setItem('twitterApiKey', twitterApiKey);
                    localStorage.setItem('twitterApiSecret', twitterApiSecret);
                    localStorage.setItem('twitterAccessToken', twitterAccessToken);
                    localStorage.setItem('twitterAccessSecret', twitterAccessSecret);

                    // Save prompts to server
                    const formData = new FormData();
                    formData.append('gptGeneration', $('#gptGenerationPrompt').val());
                    formData.append('capitalization', $('#capitalizationPrompt').val());
                    formData.append('styleAnalysis', $('#styleAnalysisPrompt').val());

                    fetch('prompts_handler.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            $('#settingsPanel').addClass('hidden');
                            showNotification('Settings and prompts saved successfully!', 'success');
                        } else {
                            showNotification('Settings saved, but failed to save prompts. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error saving prompts:', error);
                        $('#settingsPanel').addClass('hidden');
                        showNotification('Settings saved, but failed to save prompts. Please try again.', 'error');
                    });
                } else {
                    alert('Please enter a valid X Profile URL');
                }
            });

            // Cancel settings
            $('#cancelSettingsBtn').on('click', function() {
                // Reset to saved values
                $('#xProfileLink').val(xProfileLink);
                $('#replicateToken').val(replicateToken);
                $('#twitterApiKey').val(twitterApiKey);
                $('#twitterApiSecret').val(twitterApiSecret);
                $('#twitterAccessToken').val(twitterAccessToken);
                $('#twitterAccessSecret').val(twitterAccessSecret);
                // Reload prompts to reset any changes
                loadPrompts();
                $('#settingsPanel').addClass('hidden');
            });

            // URL validation helper
            function isValidUrl(string) {
                try {
                    const url = new URL(string);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch (_) {
                    return false;
                }
            }

            // Show notification
            function showNotification(message, type = 'success') {
                const bgColor = type === 'success' ? 'bg-neon-blue/20 border-neon-blue/50' : 'bg-neon-pink/20 border-neon-pink/50';
                const textColor = type === 'success' ? 'text-neon-blue' : 'text-neon-pink';
                const notification = $(`
                    <div class="fixed top-4 right-4 ${bgColor} ${textColor} border backdrop-blur-sm p-4 rounded-xl shadow-lg z-50 fade-in-up">
                        <p class="font-semibold">${message}</p>
                    </div>
                `);
                $('body').append(notification);
                setTimeout(() => {
                    notification.fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 3000);
            }

            function showStep(stepNum) {
                for (let i = 1; i < stepNum; i++) {
                    $('#step' + i).removeClass('hidden').addClass('bg-neon-pink/10 border-neon-pink');
                    $('#step' + i + ' span').first().text('✓');
                }
                $('#step' + stepNum).removeClass('hidden').addClass('border-neon-blue');
            }

            $('#generateForm').on('submit', function(e) {
                e.preventDefault();
                
                const shopifyUrl = $('#shopifyUrl').val();
                
                if (!shopifyUrl) {
                    $('#error').removeClass('hidden').find('p').last().text('Please fill in the Shopify URL');
                    return;
                }
                
                $('#loading').removeClass('hidden');
                $('#error').addClass('hidden');
                $('#preview').addClass('hidden');
                $('#extractedTweets').addClass('hidden');
                $('.loading-step').addClass('hidden').removeClass('bg-neon-pink/10 border-neon-pink');
                $('#step1').removeClass('hidden');
                $('#generateBtn').prop('disabled', true);
                
                showStep(1);
                setTimeout(() => showStep(2), 1500);
                setTimeout(() => showStep(3), 2500);
                setTimeout(() => showStep(4), 3500);
                
                $.ajax({
                    url: 'process.php',
                    type: 'POST',
                    data: {
                        shopify_url: shopifyUrl,
                        x_profile_link: xProfileLink,
                        replicate_token: replicateToken
                    },
                    dataType: 'json',
                    success: function(response) {
                        $('#loading').addClass('hidden');
                        $('#generateBtn').prop('disabled', false);
                        
                        if (response.error) {
                            $('#error').removeClass('hidden').find('p').last().text(response.error);
                        } else {
                            generatedData = response;
                            
                            // Show style analysis
                            console.log('Style analysis response:', response.extracted_tweets);
                            if (response.extracted_tweets && response.extracted_tweets.trim() !== '') {
                                // Display the style analysis with formatting
                                const styleAnalysis = response.extracted_tweets.trim();
                                
                                // Format sections with better styling
                                let formattedHTML = '<div class="space-y-4">';
                                const sections = styleAnalysis.split(/\n(?=SECTION \d+)/);
                                
                                sections.forEach(section => {
                                    const lines = section.split('\n').filter(l => l.trim() !== '');
                                    if (lines.length > 0) {
                                        formattedHTML += '<div class="border-l-2 border-neon-blue/30 pl-4 py-2">';
                                        lines.forEach(line => {
                                            if (line.match(/^SECTION \d+/)) {
                                                formattedHTML += `<h3 class="font-bold text-neon-blue mb-2">${line}</h3>`;
                                            } else if (line.match(/^—|^SECTION/)) {
                                                formattedHTML += `<h4 class="font-semibold text-white/90 mt-2 mb-1">${line}</h4>`;
                                            } else {
                                                formattedHTML += `<p class="text-white/80 text-sm leading-relaxed">${line}</p>`;
                                            }
                                        });
                                        formattedHTML += '</div>';
                                    }
                                });
                                
                                if (sections.length === 0) {
                                    // If no sections found, just display as plain text
                                    formattedHTML = `<div class="text-white/80 text-sm leading-relaxed whitespace-pre-wrap">${styleAnalysis}</div>`;
                                } else {
                                    formattedHTML += '</div>';
                                }
                                
                                $('#extractedTweetsList').html(formattedHTML);
                                $('#extractedTweets').removeClass('hidden');
                            } else {
                                $('#extractedTweetsList').html('<p class="text-white/60 italic">No writing style could be analyzed from the profile. The AI will generate based on the profile style reference only.</p>');
                                $('#extractedTweets').removeClass('hidden');
                            }
                            
                            $('#previewImg').attr('src', response.image_url);
                            $('#previewTweet').text(response.tweet);
                            $('#preview').removeClass('hidden');
                        }
                    },
                    error: function(xhr) {
                        $('#loading').addClass('hidden');
                        $('#generateBtn').prop('disabled', false);
                        
                        let errorMsg = 'Failed to generate post. Please try again.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            }
                        } catch(e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                        $('#error').removeClass('hidden').find('p').last().text(errorMsg);
                    }
                });
            });
            
            $('#postBtn').on('click', function() {
                if (!generatedData) return;
                
                $('#postBtn').prop('disabled', true).text('Launching into the X-verse...');
                
                $.ajax({
                    url: 'post.php',
                    type: 'POST',
                    data: {
                        tweet: generatedData.tweet,
                        image_url: generatedData.image_url,
                        api_key: twitterApiKey,
                        api_secret: twitterApiSecret,
                        access_token: twitterAccessToken,
                        access_secret: twitterAccessSecret
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.error) {
                            alert('Error: ' + response.error);
                            $('#postBtn').prop('disabled', false).text('POST IT');
                        } else {
                            alert('Tweet launched into the X-verse! 🚀');
                            $('#postBtn').prop('disabled', false).text('Posted!');
                            setTimeout(() => {
                                $('#preview').addClass('hidden');
                                $('#generateForm')[0].reset();
                                $('#postBtn').text('POST IT');
                            }, 2000);
                        }
                    },
                    error: function(xhr) {
                        $('#postBtn').prop('disabled', false).text('POST IT');
                        
                        let errorMsg = 'Failed to post tweet. Please try again.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            }
                        } catch(e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                        alert('Error: ' + errorMsg);
                    }
                });
            });
            
            // Scheduling functionality
            
            // Open schedule modal
            $('#scheduleBtn').on('click', function() {
                if (!generatedData) {
                    alert('Please generate a tweet first');
                    return;
                }
                
                // Set minimum date to now
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
                $('#scheduleDateTime').attr('min', localDateTime);
                $('#scheduleDateTime').val(localDateTime);
                
                $('#scheduleModal').removeClass('hidden');
            });
            
            // Cancel schedule modal
            $('#cancelScheduleBtn').on('click', function() {
                $('#scheduleModal').addClass('hidden');
            });
            
            // Close modal on backdrop click
            $('#scheduleModal').on('click', function(e) {
                if ($(e.target).attr('id') === 'scheduleModal') {
                    $('#scheduleModal').addClass('hidden');
                }
            });
            
            // Confirm schedule
            $('#confirmScheduleBtn').on('click', function() {
                const scheduledDateTime = $('#scheduleDateTime').val();
                
                if (!scheduledDateTime) {
                    alert('Please select a date and time');
                    return;
                }
                
                // Validate future date
                // Convert datetime-local to Date object (which uses local timezone)
                const selectedDate = new Date(scheduledDateTime);
                const now = new Date();
                
                if (selectedDate <= now) {
                    alert('Please select a date and time in the future');
                    return;
                }
                
                // Convert to ISO string with timezone for proper server-side parsing
                // The datetime-local input is in local time, so we convert it to ISO format
                // which includes timezone offset, so server can parse it correctly
                const scheduledDateTimeISO = selectedDate.toISOString();
                
                $('#confirmScheduleBtn').prop('disabled', true).text('Scheduling...');
                
                $.ajax({
                    url: 'schedule.php',
                    type: 'POST',
                    data: {
                        tweet: generatedData.tweet,
                        image_url: generatedData.image_url,
                        shopify_url: $('#shopifyUrl').val(),
                        scheduled_time: scheduledDateTimeISO,
                        api_key: twitterApiKey,
                        api_secret: twitterApiSecret,
                        access_token: twitterAccessToken,
                        access_secret: twitterAccessSecret
                    },
                    dataType: 'json',
                    success: function(response) {
                        if (response.error) {
                            alert('Error: ' + response.error);
                            $('#confirmScheduleBtn').prop('disabled', false).text('Schedule');
                        } else {
                            showNotification('Tweet scheduled successfully!', 'success');
                            $('#scheduleModal').addClass('hidden');
                            $('#confirmScheduleBtn').prop('disabled', false).text('Schedule');
                            
                            // Load scheduled tweets
                            loadScheduledTweets();
                        }
                    },
                    error: function(xhr) {
                        $('#confirmScheduleBtn').prop('disabled', false).text('Schedule');
                        
                        let errorMsg = 'Failed to schedule tweet. Please try again.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            }
                        } catch(e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                        alert('Error: ' + errorMsg);
                    }
                });
            });
            
            // Load scheduled tweets
            function loadScheduledTweets() {
                $.ajax({
                    url: 'get_scheduled.php',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.success && response.tweets) {
                            displayScheduledTweets(response.tweets);
                        }
                    },
                    error: function(xhr) {
                        console.error('Failed to load scheduled tweets:', xhr);
                    }
                });
            }
            
            // Display scheduled tweets
            function displayScheduledTweets(tweets) {
                const list = $('#scheduledTweetsList');
                const empty = $('#scheduledTweetsEmpty');
                
                if (tweets.length === 0) {
                    list.addClass('hidden');
                    empty.removeClass('hidden');
                    return;
                }
                
                list.removeClass('hidden');
                empty.addClass('hidden');
                
                let html = '';
                
                tweets.forEach(tweet => {
                    // Parse scheduled time - use ISO format if available, otherwise parse as UTC
                    let scheduledDate;
                    if (tweet.scheduled_time_iso) {
                        scheduledDate = new Date(tweet.scheduled_time_iso);
                    } else {
                        // If no ISO format, treat as UTC by appending 'Z' if not present
                        const timeStr = tweet.scheduled_time;
                        scheduledDate = new Date(timeStr.endsWith('Z') || timeStr.includes('+') || timeStr.includes('-') ? timeStr : timeStr + ' UTC');
                    }
                    
                    // Format in user's local timezone
                    const scheduledFormatted = scheduledDate.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                    
                    // Calculate time until/ago
                    const now = new Date();
                    const timeDiff = scheduledDate.getTime() - now.getTime();
                    let timeDisplay = '';
                    
                    if (timeDiff > 0) {
                        // Future
                        const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                        if (hours > 0) {
                            timeDisplay = `in ${hours}h ${minutes}m`;
                        } else {
                            timeDisplay = `in ${minutes}m`;
                        }
                    } else {
                        // Past
                        const hoursAgo = Math.floor(Math.abs(timeDiff) / (1000 * 60 * 60));
                        const minutesAgo = Math.floor(Math.abs(timeDiff) % (1000 * 60 * 60) / (1000 * 60));
                        if (hoursAgo > 0) {
                            timeDisplay = `${hoursAgo}h ${minutesAgo}m ago`;
                        } else {
                            timeDisplay = `${minutesAgo}m ago`;
                        }
                    }
                    
                    let statusBadge = '';
                    let statusColor = '';
                    let statusIcon = '';
                    
                    if (tweet.status === 'pending') {
                        statusBadge = 'Pending';
                        statusColor = 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400';
                        statusIcon = '⏳';
                    } else if (tweet.status === 'posted') {
                        statusBadge = 'Posted';
                        statusColor = 'bg-green-500/20 border-green-500/50 text-green-400';
                        statusIcon = '✅';
                    } else if (tweet.status === 'failed') {
                        statusBadge = 'Failed';
                        statusColor = 'bg-red-500/20 border-red-500/50 text-red-400';
                        statusIcon = '❌';
                    } else {
                        statusBadge = tweet.status;
                        statusColor = 'bg-white/10 border-white/20 text-white/60';
                        statusIcon = '⏸️';
                    }
                    
                    html += `
                        <div class="bg-chrome-accent/60 backdrop-blur-sm border border-white/20 rounded-xl p-5 hover:border-white/30 transition-all">
                            <div class="flex gap-4">
                                <!-- Image -->
                                <div class="flex-shrink-0">
                                    <img 
                                        src="${escapeHtml(tweet.image_url)}" 
                                        alt="Scheduled tweet image" 
                                        class="w-32 h-32 object-cover rounded-xl border border-white/20"
                                        onerror="this.src='https://via.placeholder.com/128x128?text=Image'"
                                    >
                                </div>
                                
                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <!-- Header with status and time -->
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center gap-3 flex-wrap">
                                            <span class="px-2.5 py-1 rounded-lg text-xs font-semibold border ${statusColor} flex items-center gap-1.5">
                                                <span>${statusIcon}</span>
                                                <span>${statusBadge}</span>
                                            </span>
                                            <div class="flex items-center gap-2 text-white/60 text-xs">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <span>${timeDisplay}</span>
                                            </div>
                                        </div>
                                        ${tweet.status === 'pending' ? `
                                            <button 
                                                class="cancel-schedule-btn px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-400 rounded-lg text-xs font-semibold transition-all whitespace-nowrap"
                                                data-id="${tweet.id}"
                                                title="Cancel"
                                            >
                                                Cancel
                                            </button>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Scheduled time -->
                                    <div class="text-white/50 text-xs mb-3">
                                        Scheduled for: ${scheduledFormatted}
                                    </div>
                                    
                                    <!-- Tweet text -->
                                    <p class="text-white/90 text-sm leading-relaxed whitespace-pre-wrap break-words">
                                        ${escapeHtml(tweet.tweet_text)}
                                    </p>
                                    
                                    <!-- Error message if failed -->
                                    ${tweet.error_message ? `
                                        <div class="mt-3 p-3 bg-red-500/10 border border-red-500/30 rounded-lg">
                                            <div class="flex items-start gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <p class="text-red-400 text-xs leading-relaxed">${escapeHtml(tweet.error_message)}</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Posted timestamp if posted -->
                                    ${tweet.status === 'posted' && tweet.posted_at ? `
                                        <div class="mt-3 text-green-400/80 text-xs flex items-center gap-1.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                            <span>Posted at: ${(() => {
                                                const postedDate = tweet.posted_at_iso ? new Date(tweet.posted_at_iso) : new Date(tweet.posted_at);
                                                return postedDate.toLocaleString('en-US', {
                                                    year: 'numeric',
                                                    month: 'numeric',
                                                    day: 'numeric',
                                                    hour: 'numeric',
                                                    minute: '2-digit',
                                                    second: '2-digit',
                                                    hour12: true
                                                });
                                            })()}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                list.html(html);
                
                // Bind cancel buttons
                $('.cancel-schedule-btn').on('click', function() {
                    const id = $(this).data('id');
                    cancelScheduledTweet(id);
                });
            }
            
            // Cancel scheduled tweet
            function cancelScheduledTweet(id) {
                if (!confirm('Are you sure you want to cancel this scheduled tweet?')) {
                    return;
                }
                
                $.ajax({
                    url: 'cancel_schedule.php',
                    type: 'POST',
                    data: { id: id },
                    dataType: 'json',
                    success: function(response) {
                        if (response.error) {
                            alert('Error: ' + response.error);
                        } else {
                            showNotification('Scheduled tweet cancelled', 'success');
                            loadScheduledTweets();
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'Failed to cancel scheduled tweet.';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMsg = response.error;
                            }
                        } catch(e) {
                            errorMsg = xhr.responseText || errorMsg;
                        }
                        alert('Error: ' + errorMsg);
                    }
                });
            }
            
            // Refresh scheduled tweets button
            $('#refreshScheduledBtn').on('click', function() {
                loadScheduledTweets();
                showNotification('Scheduled tweets refreshed', 'success');
            });
            
            // Escape HTML helper
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Load scheduled tweets on page load
            loadScheduledTweets();
            
            // Auto-refresh scheduled tweets list every 10 seconds
            setInterval(function() {
                loadScheduledTweets();
            }, 10000); // Refresh every 10 seconds
            
            // Auto-check for due tweets every 30 seconds (less frequent to avoid overload)
            setInterval(function() {
                // Run scheduler to check and post due tweets
                $.ajax({
                    url: 'run_scheduler.php',
                    type: 'GET',
                    dataType: 'json',
                    timeout: 10000, // 10 second timeout
                    success: function(response) {
                        // Silently check - if tweets were posted, they'll show up on next refresh
                    },
                    error: function(xhr) {
                        // Silently fail - cron job might not be set up yet
                        console.log('Scheduler check completed (errors are normal if cron is not set up)');
                    }
                }).always(function() {
                    // Refresh scheduled tweets list after running scheduler
                    loadScheduledTweets();
                });
            }, 30000); // Check every 30 seconds
            
            // Also run immediately on page load
            setTimeout(function() {
                $.ajax({
                    url: 'run_scheduler.php',
                    type: 'GET',
                    timeout: 10000,
                    error: function() {
                        console.log('Scheduler check completed');
                    }
                }).always(function() {
                    loadScheduledTweets();
                });
            }, 2000); // Wait 2 seconds after page load
        });
    </script>
</body>
</html>
